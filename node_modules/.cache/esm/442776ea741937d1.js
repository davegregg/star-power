let User;_741‍.x([["connectToMongo",()=>connectToMongo],["checkIfUser",()=>checkIfUser],["userHasEnoughStars",()=>userHasEnoughStars],["handleTransaction",()=>handleTransaction],["showLeaderboard",()=>showLeaderboard]]);_741‍.w("./models/User",[["User",["User"],function(v){User=v}]]);const mongoose = require("mongoose");

let connectedToDB = false;

       function connectToMongo() {
	if (!connectedToDB) {
		mongoose.connect(process.env.MONGO_URI, {
			useNewUrlParser: true,
			useUnifiedTopology: true,
		});
		const db = mongoose.connection;
		db.on("error", _741‍.g.console.error.bind(_741‍.g.console, "connection error:"));
		db.once("open", function () {
			// we're connected!
			console.log("Connected to MongoDB");
		});
		connectedToDB = true;
	} else {
		console.log("Already connected");
	}
}

       function checkIfUser(username) {
	if (username[0] === "@") {
		username = username.substring(1);
	}
	if (username.length !== 11) {
		console.log("username format is wrong");
		return;
	}
	User.findOne({ username: username }).exec(function (err, user) {
		if (user) {
			return;
		} else {
			const newUser = new User({
				username: username,
				stars: 2,
				amountGiven: 0,
			});

			newUser.save((err) => {
				if (err) {
					_741‍.g.console.log(err);
				}
				console.log("User Created");
			});
		}
	});
}

       async function userHasEnoughStars(username, starsSent) {
	let foundUser = await User.findOne({ username: username });
	return !(foundUser.stars < starsSent);
}

function takeStars(username, amount) {
	User.findOne({ username: username }, (err, user) => {
		if (!user) {
			console.log("User doesn't exist. How'd you do this?");
		}
		user.amountGiven += 1;
		user.stars -= amount;
		user.save();
		console.log(`${username}'s new balance: ${user.stars}`);
	});
}

function giveStars(username, amount) {
	User.findOne({ username: username }, (err, user) => {
		if (!user) {
			console.log("User doesn't exist. How'd you do this?");
		}
		if (err) {
			_741‍.g.console.log(err);
			return;
		}
		user.stars += amount;
		user.save();
		console.log(`${username}'s new balance: ${user.stars}`);
	});
}

       function handleTransaction(sender, receiver, starsSent) {
	takeStars(sender, starsSent);
	if (receiver.length > 1) {
		starsSent = starsSent / receiver.length;
	}
	for (let user of receiver) {
		checkIfUser(user);
		giveStars(user, starsSent);
	}
}

       function showLeaderboard() {
	User.find({}, function (err, users) {
		let userMap = {};

		users.forEach(function (user) {
			userMap[user._id] = user;
		});
		// let sortedStars = Object.values(userMap);
		for (const value of Object.values(userMap.stars)) {
			_741‍.g.console.log(value);
		}
	});
}
